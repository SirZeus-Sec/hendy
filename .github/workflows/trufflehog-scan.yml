name: Secret Scan

on:
  pull_request:
    branches:
      - main  # Run on PRs to the main branch

jobs:
  secret-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install TruffleHog
        run: pip install trufflehog

      - name: Run TruffleHog on PR Changes
        id: trufflehog
        continue-on-error: true  # Prevents GitHub Actions from stopping immediately
        run: |
          trufflehog git --since-commit=$(git merge-base origin/main HEAD) --json > secrets.json || true

      - name: Check for Secrets
        run: |
          if grep -q '"SourceType": "git"' secrets.json; then
            echo "❌ Secret detected in PR!"
            exit 1
          else
            echo "✅ No secrets found."
          fi
